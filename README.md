## **팀원 역할 담당** <!-- (예시)홍길동 : od 모델 학습 ... -->

강형우 - 데이터 수집, 데이터 라벨링, 신호등 색 인지 , 정지선 인식

한지호 - 데이터 수집, 데이터 라벨링, 모델 학습, 차선인식, 주행 제어

## **데이터셋**

### train, validation 데이터 수 <!-- 전체 학습, 평가 데이터 수와 함께 각 클래스별 데이터 수 -->
(클래스별) 학습 데이터 수 : 4500장 (거의 균등하게 모든 클래스를 맞춤)  
(클래스별) 평가 데이터 수 : 500장 (평가를 위한 데이터를 따로 만듬 해당 데이터)  
검수 완료

### 데이터 수집 방법
자이카 카메라로 동영상을 찍은 다음에 10프레임 단위로 끊어서 이미지 생성

### 라벨링 기준
1. 우회전, 좌회전은 멀어져서 화살표 부분에서 직각 부분이 안보이면 무시 처리  
2. 횡단보드는 글자가 너무 작아져서 아예 안보이는 경우 무시 처리  
3. 겹치는 건 50퍼센트 이상이면 박스를 아예 안침  
4. 화살표의 경우 기둥이나 방향이 모두 잘리면 박스를 아예 안침  

### 사용한 어그멘테이션
기본적으로 제공 - 어파인, 밝기, 색조, 좌우 반전  
사용자가 추가 - 모션블러

## **학습 과정 및 결과** <!-- 기능을 Commit 별로 잘게 쪼개고, Commit 별로 설명해주세요-->
1일차 - 데이터 2500장 정도 수집함. 데이터 라벨링 기준을 정하고 데이터 라벨링 시작.  
2일차 - 데이터 라벨링을 하면서 유난히 적은 데이터를 보완 + 어두운 환경에서 추가 데이터 수집. 어느 정도 라벨링된 데이터로 학습 시작.  
3일차 - 학습 결과를 자이카에 직접 포팅에서 결과를 확인. -> 흔들릴때마다 인식이 잘되지 않는 것을 확인. (아래의 영상 참고)

https://user-images.githubusercontent.com/62413303/213511935-9fe4c595-543e-48de-adec-cefc4163d82e.mov

4일차 - 데이터 라벨링 마무리 + 검수 진행(해당 과정에서 잘못된 라벨링을 많이 수정함.) 정제된 데이터로 다시 학습 시작.  
5일차 - 기존 데이터로 학습을 마무리. 모션 블러 어그멘테이션 추가.  


2일동안 1650에포크 학습을 진행함.  
자이카에 포팅한 최종결과  

https://user-images.githubusercontent.com/62413303/219025055-28c2241a-b7ae-426e-8941-ecefb5a75d16.mp4



### hyperparameter <!-- batch수, learning_rate, optimizer 등-->
기본제공된 코드와 동일.

optimizer를 adam으로 한번 바꾸어 보았는데 정확도가 더 떨어졌었음.

### loss, accuracy 그래프
![image](https://user-images.githubusercontent.com/62413303/213513989-d15d0f77-9b88-4d0e-ae52-b44593af1342.png)
![image](https://user-images.githubusercontent.com/62413303/213507558-df7d492a-3ac8-4ff1-bb76-a8a1e90621d4.png)

## **제어 알고리즘** <!-- 알고리즘을 flowchart 방식으로 표현  -->
![KakaoTalk_20230215_204629693](https://user-images.githubusercontent.com/62413303/219019112-a1d7719a-ea87-4698-b56d-07afcd1d6ecb.jpg)

## **✅ 어려웠던 부분 & 개선 방법** <!-- 학습 과정 중 생겼던 문제 or 제어에서 생겼던 문제 -->
1.교차로 구간에서 차선 인지  
일단 먼저 직선 구간에서는 조향각이 크게 변할 필요가 없기 때문에 직선과 곡선구간의 PID값을 다르게 설정했다. 그리고 기존 차선 인식 코드는 차선을 잃으면 초기화되는 코드가 들어있었는데 해당 코드를 그대로 사용하면 교차로에서 왼쪽이나 오른쪽에서 먼저 초기화가 되면 방향을 확 틀어버린 채로 직진을 해버리는 문제가 있었다. 그래서 차선을 잃으면 기존차선을 유지하도록 코드를 변경하였다.  
  
2.합류 구간에서 차선 인지  
합류구간에서 제대로된 차선을 인지하기 힘들었다. 기울기가 0이 되어 rpos와 lpos가 교차되는 일도 발생하고 원하는 값과 거리가 먼 값들이 나오는 경우도 더러 있었다. 이를 해결하기 위해 차선만 이용하는 방법을 택했다. 제어에 자신이 있었기 때문에 제어값만 찾는다면 훨씬 더 안정적인 주행이 가능할 것이라 보았다.  
  
3.신호등 색 인지  
신호등 색 인에서 그 날 외부에서 들어오는 빛의 광량에 따라 V값이 민감하게 반응을 하여 낮시간대에 잘 작동하던 HSV세팅값이 저녁이 되면 또 다르게 세팅을 해주어야 했습니다.
이번 프로젝트에서는 딥러닝으로 신호등을 검출하는 방법으로 진행하였는데, 머신러닝이 아닌 딥러닝이므로 신호등인것뿐만 아니라 빨간색 신호등, 노란색 신호등, 초록색 신호등 각각 따로 인식이 가능한데 이를 적용해보았으면 HSV 파라미터 튜닝하느라 고생을 덜 했을것 같다.

### 신호등 색 분류 방법
신호등 분류 방법은 HSV 색 공간 검출이라는 방법을 사용했고, 그 안에서 2가지로 나누어 2방법을 모두 사용해 보았습니다.
첫번째 방법으로는 OpenCV의 HoughCirle함수를 이용했습니다. 신호등BoungdingBox를 crop하여 HSV를 이용한 색상이 검출되면 binary 이미지를 maks로 사용하여 원본 이미지에서 범위값에 해당되는 부분에 흰색이 신호등 원모양으로 동그렇게 찍히게 되면 HoughCircle에서 원이 검출이 되고, 검출된 원이 특정 색상의 원이므로 원이 검출될때마다 특정색상의 id값을 return 해주었습니다.
하지만 문제점은, 자이카가 신호등 가까이에 갔을때 조명이 신호등 불빛에 반사가 되어 검출되어야 하는 색상이 아닌 다른곳에서 mask된 원본 이미지에서 해당 부분에 흰색이 찍히게 되었고, 그 결과 다른색 원이 검출되어 검출해야할 색상의id가 아닌 다른색상의 id를 return하는 문제가 발생했습니다. 간헐적으로만 발생한다면 문제가 없을 것이지만 다른색상 검출이 꽤 잦은 빈도로 나타나 2번째 방법을 사용했습니다.
2번째 방법은 BoundingBox의 신호등BoungdingBox를 crop하여 HSV를 이용한 색상이 검출되면 binary 이미지를 maks로 사용하여 원본 이미지에서 범위값에 해당되는 부분에서의 픽셀값 개수를 계산했습니다. 이렇게 되면 이 전에 발생했던 가끔 다른색이 튀어도, 본래 검출하고자 하는 색상의 색이 훨씬 검출이 잘 되므로 픽셀값 개수가 많을것이고 따라서 문제없이 잘 검출이 되었습니다. 

### 표지판 인식 관련
bbox크기로 필터링을 진행함.  
신호등의 경우 인지가 안되어야 하는 경우에도 인지가 될 때가 있어서 bbox높이/bbox넓이로 한번 더 필터링을 진행함.

## **✅ 잘 되었던 부분**
표지판 인지 움직이는 경우에도 흔들없이 인지가 잘됐음.
